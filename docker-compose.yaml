services:
    # MailHog
    mailhog:
        image: mailhog/mailhog
        container_name: 'mailhog'
        ports:
            - "1025:1025"
            - "8025:8025"
        networks:
            - librarysite-network
    
    # PostgreSQL Database
    db:
        image: postgres:16.0
        container_name: 'postgres-db'
        environment:
            POSTGRES_PASSWORD: ${DB_PASSWORD}
            POSTGRES_USER: ${DB_USER}
            POSTGRES_DB: ${DB_NAME}
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
            interval: 10s
            timeout: 10s
            retries: 5
        volumes:
            - db-data:/var/lib/postgresql/data
        ports:
            - "5432:5432"
        networks:
            - librarysite-network
    
    # Django API
    api:
        image: librarysite
        container_name: 'librarysite-api'
        build: 
            context: ./
            dockerfile: Dockerfile
        depends_on:
            db:
                condition: service_healthy
            mailhog:
                condition: service_started
        environment:
            # Django settings
            SECRET_KEY: ${SECRET_KEY}
            DEBUG: ${DEBUG}
            
            # Database configuration
            DB_NAME: ${DB_NAME}
            DB_USER: ${DB_USER}
            DB_PASSWORD: ${DB_PASSWORD}
            DB_HOST: db
            DB_PORT: 5432
            
            # Email configuration
            EMAIL_BACKEND: ${EMAIL_BACKEND}
            EMAIL_HOST: mailhog
            EMAIL_PORT: 1025
            EMAIL_USE_TLS: ${EMAIL_USE_TLS}
            EMAIL_USE_SSL: ${EMAIL_USE_SSL}
            EMAIL_HOST_USER: ${EMAIL_HOST_USER}
            EMAIL_HOST_PASSWORD: ${EMAIL_HOST_PASSWORD}
            DEFAULT_FROM_EMAIL: ${DEFAULT_FROM_EMAIL}
        ports:
            - "8000:8000"
        networks:
            - librarysite-network
        volumes:
            - ./librarysite:/librarysite/librarysite

volumes:
    db-data:

networks:
    librarysite-network:
        driver: bridge